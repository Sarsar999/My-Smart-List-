<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Smart List</title>
    <style>
        /* --- CSS Variables Definition --- */
        :root {
            --body-bg: #f0f4f8;
            --body-text: #333;
            --card-bg: #ffffff;
            --card-shadow: rgba(0, 0, 0, 0.07);
            --header-h1-text: #2d3748;
            --primary-accent: #48bb78; /* Main green */
            --primary-accent-darker: #38a169;
            --primary-accent-lighter-for-dark: #68d391;
            --secondary-text: #718096;
            --button-border: #cbd5e0;
            --button-bg: #fff;
            --button-text: #4a5568;
            --button-hover-bg: #f7fafc;
            --button-hover-border: #a0aec0;
            --label-text: #4a5568;
            --input-border: #cbd5e0;
            --input-bg: #f7fafc;
            --input-text: #333;
            --input-focus-border: var(--primary-accent);
            --button-primary-text: white;
            --list-item-bg: #f7fafc;
            --checkbox-border: #cbd5e0;
            --checkbox-bg: #fff;
            --checkbox-tick-color: white;
            --item-name-text: #2d3748;
            --price-text: #38a169;
            --completed-text: #a0aec0;
            --completed-price-text: #68d391;
            --completed-item-bg: #e2e8f0;
            --delete-btn-text: #fc8181;
            --delete-btn-hover-text: #f56565;
            --archive-btn-bg: #63b3ed;
            --archive-btn-hover-bg: #4299e1;
            --button-disabled-bg: #a0aec0;
            --empty-message-text: #a0aec0;
            --edit-icon-color: #D32F2F;
            --edit-icon-hover-color: #B71C1C;
            --nav-bg: var(--card-bg);
            --nav-text: var(--secondary-text);
            --nav-active-text: var(--primary-accent);
            --nav-icon-size: 1.4em;


            /* History Specific */
            --history-item-bg: #e9f5ee;
            --history-group-header-bg: #e2e8f0;
            --history-group-total-bg: #e2e8f0;
            --history-group-total-border-top: #cbd5e0;
            --history-item-border-left: #68d391;
            --history-item-separator-border: #d1e7dd;
            --history-overall-total-bg: #d1e7dd;
            --history-overall-total-text: #1c4532;
            --history-overall-total-border-top: #48bb78;
            --danger-text: #cc0000;
            --danger-hover-bg: #ffdddd;
            --danger-hover-text: #aa0000;
            --danger-action-bg: #fc8181;
            --danger-action-hover-bg: #f56565;
        }

        body.dark-theme {
            --body-bg: #1a202c;
            --body-text: #e2e8f0;
            --card-bg: #2d3748;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --header-h1-text: #edf2f7;
            --primary-accent: #48bb78;
            --primary-accent-darker: #38a169;
            --primary-accent-lighter-for-dark: #48bb78;
            --secondary-text: #a0aec0;
            --button-border: #4a5568;
            --button-bg: #2d3748;
            --button-text: #cbd5e0;
            --button-hover-bg: #4a5568;
            --button-hover-border: #718096;
            --label-text: #a0aec0;
            --input-border: #4a5568;
            --input-bg: #1a202c;
            --input-text: #e2e8f0;
            --input-focus-border: var(--primary-accent-lighter-for-dark);
            --button-primary-text: #e2e8f0;
            --list-item-bg: #2c3645;
            --checkbox-border: #4a5568;
            --checkbox-bg: #1a202c;
            --item-name-text: #e2e8f0;
            --price-text: #68d391;
            --completed-text: #718096;
            --completed-price-text: #48bb78;
            --completed-item-bg: #4a5568;
            --delete-btn-text: #e53e3e;
            --delete-btn-hover-text: #c53030;
            --archive-btn-bg: #4299e1;
            --archive-btn-hover-bg: #3182ce;
            --button-disabled-bg: #4a5568;
            --empty-message-text: #718096;
            --edit-icon-color: #EF5350;
            --edit-icon-hover-color: #D32F2F;
            --nav-bg: var(--card-bg);
            --nav-text: var(--secondary-text);
            --nav-active-text: var(--primary-accent-lighter-for-dark);


            /* History Specific */
            --history-item-bg: #2c3e50;
            --history-group-header-bg: #4a5568;
            --history-group-total-bg: #4a5568;
            --history-group-total-border-top: #718096;
            --history-item-border-left: #48bb78;
            --history-item-separator-border: #4a5568;
            --history-overall-total-bg: #38a169;
            --history-overall-total-text: #edf2f7;
            --history-overall-total-border-top: #68d391;
            --danger-text: #f56565;
            --danger-hover-bg: #4a5568;
            --danger-hover-text: #e53e3e;
            --danger-action-bg: #e53e3e;
            --danger-action-hover-bg: #c53030;
        }

        /* --- Global Styles & Resets (Using CSS Variables) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg); color: var(--body-text);
            line-height: 1.5; display: flex; justify-content: center;
            padding: 20px 10px;
            padding-bottom: 80px;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- App Container --- */
        .app-container {
            background-color: transparent; width: 100%; max-width: 500px;
            display: flex; flex-direction: column; gap: 15px;
            position: relative;
            padding-bottom: 60px;
        }
        
        /* --- Settings Button Styling --- */
        .settings-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--button-border);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px var(--card-shadow);
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            z-index: 1000;
        }
        .settings-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.1);
        }
        body.dark-theme .settings-button {
            background: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--button-border);
        }
         body.dark-theme .settings-button:hover {
            background-color: var(--button-hover-bg);
        }


        /* --- Card Style (Using CSS Variables) --- */
        .card {
            background-color: var(--card-bg); padding: 18px;
            border-radius: 12px; box-shadow: 0 4px 15px var(--card-shadow);
            transition: background-color 0.3s, opacity 0.3s, max-height 0.3s ease-out;
        }
        .add-item-section.card.hidden {
             padding-top: 0;
             padding-bottom: 0;
             margin-bottom: -15px;
             opacity: 0;
             max-height: 0;
             overflow: hidden;
             border: none;
        }
        
        /* --- Settings Modal --- */
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 380px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .settings-modal.card {
             padding: 15px;
             box-shadow: 0 8px 30px var(--card-shadow);
        }

        .settings-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--button-border);
            margin-bottom: 5px;
        }
        .settings-modal-header h2 {
            font-size: 1.2em;
            color: var(--header-h1-text);
            margin: 0;
            font-weight: 600;
        }
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 1.6em;
            font-weight: bold;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0 3px;
            line-height: 1;
        }
        .close-modal-btn:hover {
            color: var(--primary-accent);
        }
        .settings-modal-content {
             display: flex;
             flex-direction: column;
             gap: 10px;
        }
        .settings-modal-content .settings-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.95em;
            color: var(--label-text);
            gap: 10px;
        }
        .settings-modal-content .settings-option-row label {
            margin-bottom: 0;
            font-weight: 500;
            flex-shrink: 0;
        }
        .settings-modal .settings-option-row select {
            padding: 7px 9px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 0.95em;
            flex-grow: 1;
            min-width: 120px;
        }
        .settings-modal .settings-option-row select:focus {
             border-color: var(--input-focus-border);
             outline: none;
        }

        .settings-modal-content .settings-action-button {
            padding: 7px 12px;
            border-radius: 6px;
            border: 1px solid var(--button-border);
            background-color: var(--button-bg);
            color: var(--button-text);
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            min-width: 150px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .settings-modal-content .settings-action-button:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--button-hover-border);
        }


        /* --- Modal Overlay --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1050;
        }
        body.dark-theme .modal-overlay {
            background-color: rgba(30, 30, 40, 0.6);
        }


        /* --- Add Item Section (Using CSS Variables) --- */
        .add-item-section h2 { font-size: 1.2em; color: var(--primary-accent); margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; }
        .add-item-section h2 .icon { margin-right: 8px; font-size: 1.1em; }
        .add-item-section .instructions { font-size: 0.85em; color: var(--secondary-text); margin-bottom: 12px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 0.85em; font-weight: 500; margin-bottom: 4px; color: var(--label-text); }
        .input-group input[type="text"], .input-group input[type="number"], .input-group select {
            width: 100%; padding: 9px 11px; border: 1px solid var(--input-border); border-radius: 8px;
            font-size: 0.95rem; outline: none; transition: border-color 0.3s ease; background-color: var(--input-bg);
            color: var(--input-text);
        }
        .input-group input:focus, .input-group select:focus { border-color: var(--input-focus-border); }
        .inline-inputs { display: flex; gap: 10px; }
        .inline-inputs .input-group { flex: 1; margin-bottom: 0; }
        #addButton {
            display: block; width: 100%; padding: 11px 20px; background-color: var(--primary-accent); color: var(--button-primary-text);
            border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;
            transition: background-color 0.3s ease; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #addButton:hover, #addButton:focus { background-color: var(--primary-accent-darker); }

        /* --- Grocery List Section (Using CSS Variables) --- */
         #listSection .list-section-title {
            font-size: 1.8em;
            color: var(--primary-accent);
            margin-bottom: 12px;
            font-weight: 600;
            text-align: center;
        }
        #groceryList { list-style-type: none; padding: 0; }
        #groceryList li {
            display: flex; align-items: center;
            padding: 10px 5px 10px 10px; background-color: var(--list-item-bg);
            border-radius: 8px; margin-bottom: 8px;
            transition: background-color 0.2s ease, opacity 0.3s ease; gap: 8px;
        }
        #groceryList li:last-child { margin-bottom: 0; }

        /* List item checkbox */
        #groceryList li input[type="checkbox"] {
            appearance: none; background-color: var(--checkbox-bg); border: 1px solid var(--checkbox-border);
            width: 18px; height: 18px; border-radius: 4px; cursor: pointer;
            position: relative; flex-shrink: 0; margin-top: 2px;
        }
        #groceryList li input[type="checkbox"]:checked { background-color: var(--primary-accent); border-color: var(--primary-accent); }
        #groceryList li input[type="checkbox"]:checked::after {
            content: '‚úî'; font-size: 12px; color: var(--checkbox-tick-color); position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;
        }

        /* List item details container */
        #groceryList li .item-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            font-size: 0.95rem;
            word-break: break-word;
            gap: 4px;
        }

        /* View Mode for item details */
        .item-view-mode .item-name-line {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .item-view-mode .item-name { font-weight: 500; color: var(--item-name-text); flex-grow: 1; }
        .item-view-mode .item-qty-unit { font-size: 0.8em; color: var(--secondary-text); }
        .item-view-mode .item-price-container { display: flex; align-items: center; margin-top: 2px; }
        .item-view-mode .item-price { font-size: 0.8em; color: var(--price-text); font-weight: 500; display: inline; }
        
        .edit-item-btn {
            background: none; border: none;
            color: var(--edit-icon-color);
            cursor: pointer; font-size: 1.1em;
            padding: 0 3px;
            margin-left: 5px;
            line-height: 1; display: inline-flex; align-items: center; justify-content: center;
            transition: color 0.2s, transform 0.2s; flex-shrink: 0;
            transform: rotate(100deg);
            position: relative;
            top: -2px;
        }
        .edit-item-btn:hover {
            color: var(--edit-icon-hover-color);
            transform: rotate(90deg) scale(1.1);
        }

        .edit-price-btn {
            background: none; border: none;
            color: var(--edit-icon-color);
            cursor: pointer; font-size: 1.1em; padding: 0 3px; margin-left: 5px;
            line-height: 1; display: inline-block; text-decoration: none !important;
            transform: rotate(100deg); transition: color 0.2s, transform 0.2s;
            position: relative; top: -4px;
        }
        .edit-price-btn:hover {
            color: var(--edit-icon-hover-color);
            transform: rotate(90deg) scale(1.1);
        }
        #groceryList li .item-price-input {
            display: none; margin-top: 5px; padding: 6px 8px; border: 1px solid var(--input-border);
            border-radius: 6px; font-size: 0.9rem; width: 100px; background-color: var(--input-bg);
            color: var(--input-text);
        }
        #groceryList li .item-price-input:focus { border-color: var(--input-focus-border); outline: none; }


        /* Edit Mode for item details (name, qty, unit) */
        .item-edit-mode { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .item-edit-mode .input-group-condensed label {
            font-size: 0.75em;
            margin-bottom: 2px;
            color: var(--label-text);
            display: block;
        }
        .item-edit-mode .input-group-condensed input,
        .item-edit-mode .input-group-condensed select {
            width: 100%;
            padding: 5px 8px;
            font-size: 0.9rem;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--input-text);
        }
        .item-edit-mode .inline-inputs-condensed { display: flex; gap: 8px; }
        .item-edit-mode .inline-inputs-condensed .input-group-condensed { flex: 1; }
        .item-edit-mode .item-edit-actions { display: flex; gap: 8px; margin-top: 5px; justify-content: flex-end; }
        .item-edit-mode .item-edit-actions button {
            padding: 5px 10px; font-size: 0.8em; border-radius: 6px;
            border: 1px solid var(--button-border); background-color: var(--button-bg);
            color: var(--button-text); cursor: pointer; transition: background-color 0.2s;
        }
        .item-edit-mode .item-edit-actions button.save-item-edit-btn { background-color: var(--primary-accent); color: var(--button-primary-text); border-color: var(--primary-accent); }
        .item-edit-mode .item-edit-actions button.save-item-edit-btn:hover { background-color: var(--primary-accent-darker); }
        .item-edit-mode .item-edit-actions button.cancel-item-edit-btn:hover { background-color: var(--button-hover-bg); }


        /* Completed state for current list items */
        #groceryList li.completed { background-color: var(--completed-item-bg); opacity: 0.8; }
        #groceryList li.completed .item-view-mode .item-name,
        #groceryList li.completed .item-view-mode .item-qty-unit {
            color: var(--completed-text);
            text-decoration: line-through;
        }
        #groceryList li.completed .item-view-mode .item-price { text-decoration: none; color: var(--completed-price-text); }
        
        #groceryList li.completed .edit-item-btn,
        #groceryList li.completed .edit-price-btn {
             color: var(--edit-icon-color);
        }
         #groceryList li.completed .edit-item-btn:hover,
         #groceryList li.completed .edit-price-btn:hover {
             color: var(--edit-icon-hover-color);
         }


        /* Delete button */
        .delete-btn {
            background: none; border: none; color: var(--delete-btn-text); cursor: pointer;
            font-size: 1.2rem; padding: 5px; line-height: 1; flex-shrink: 0;
            transition: color 0.3s ease;
        }
        .delete-btn:hover, .delete-btn:focus { color: var(--delete-btn-hover-text); }

        /* History Group Styling */
        #groceryList li.history-group-header {
            background-color: var(--history-group-header-bg); padding: 8px 10px; margin-top: 15px;
            font-weight: bold; color: var(--header-h1-text); border-radius: 6px 6px 0 0;
            font-size: 0.9em; list-style-type: none; display: block;
            align-items: initial; gap: initial; margin-bottom: 0;
        }
        #groceryList li.history-group-header:first-child { margin-top: 0; }

        #groceryList li.history-item {
            background-color: var(--history-item-bg); opacity: 1; text-decoration: none;
            padding: 10px 5px 10px 15px;
            display: flex; align-items: center; gap: 8px;
            border-radius: 0; margin-bottom: 0;
            border-left: 3px solid var(--history-item-border-left);
        }
        #groceryList li.history-item + li.history-item,
        #groceryList li.history-item + li.history-group-total,
        #groceryList li.empty-message.history-group-empty-item + li.history-group-total {
            border-top: 1px solid var(--history-item-separator-border);
        }
        
        #groceryList li.history-group-total {
            background-color: var(--history-group-total-bg);
            padding: 8px 10px;
            margin-top: 0; margin-bottom: 15px;
            font-weight: 600; color: var(--price-text);
            border-radius: 0 0 6px 6px;
            font-size: 0.85em; list-style-type: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border-top: 1px dashed var(--history-group-total-border-top);
        }
        .history-group-total-text {
            flex-grow: 1;
            padding-left: 5px;
        }
        .remove-group-btn {
            background: none; border: none; color: var(--danger-text);
            cursor: pointer; font-size: 1.1em;
            padding: 2px 5px; line-height: 1; border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .remove-group-btn:hover, .remove-group-btn:focus {
            background-color: var(--danger-hover-bg); color: var(--danger-hover-text);
        }
        
        #groceryList li.history-item .item-details { text-decoration: none; }
        #groceryList li.history-item .item-name {
            color: var(--price-text);
            font-weight: 500;
        }
        #groceryList li.history-item .item-qty-unit { color: var(--secondary-text); }
        #groceryList li.history-item .item-price {
            color: var(--price-text);
            font-weight: bold;
        }
        #groceryList li.history-item .item-datetime { display: none; }


        #groceryList li.history-overall-total {
            background-color: var(--history-overall-total-bg); padding: 12px 10px; margin-top: 20px;
            margin-bottom: 5px; font-weight: bold; color: var(--history-overall-total-text);
            border-radius: 8px; font-size: 1.1em; list-style-type: none;
            display: block; text-align: center; border-top: 2px solid var(--history-overall-total-border-top);
            align-items: initial; gap: initial;
        }

        /* --- Total Spent Section (Current List) --- */
        .total-spent-section { text-align: center; }
        .total-spent-section h2 { font-size: 1.1em; color: var(--primary-accent); margin-bottom: 5px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .total-spent-section .total-amount { font-size: 1.8em; font-weight: bold; color: var(--header-h1-text); }

        /* --- Archive Button --- */
        #archiveButton {
            display: block; width: 100%; padding: 10px 15px; background-color: var(--archive-btn-bg); color: var(--button-primary-text);
            border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500;
            transition: background-color 0.3s ease; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #archiveButton:disabled { background-color: var(--button-disabled-bg); cursor: not-allowed; }
        #archiveButton:not(:disabled):hover { background-color: var(--archive-btn-hover-bg); }

        /* --- Empty List/History Message --- */
        .empty-message {
            text-align: center; color: var(--empty-message-text); padding: 15px; font-style: italic;
            background: none !important; display: block;
            align-items: initial; gap: initial; border-radius: 8px;
            margin-bottom: 8px;
        }
        #groceryList li.empty-message.history-group-empty-item {
             background-color: var(--history-item-bg) !important;
             border-radius: 0;
             padding-left: 15px;
             text-align: left;
             border-left: 3px solid var(--history-item-border-left);
             color: var(--secondary-text);
        }
        
        /* Styling for Clear All History button */
        .clear-history-button {
            display: block;
            width: calc(100% - 20px);
            margin: 20px auto 10px auto;
            padding: 10px 15px;
            background-color: var(--danger-action-bg);
            color: var(--button-primary-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .clear-history-button:hover, .clear-history-button:focus {
            background-color: var(--danger-action-hover-bg);
        }
        
        /* --- Bottom Navigation --- */
        .bottom-nav {
            display: flex;
            background-color: var(--nav-bg);
            box-shadow: 0 -2px 10px var(--card-shadow);
            border-top: 1px solid var(--button-border);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 900;
        }
        .bottom-nav-inner {
            display: flex;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .bottom-nav .nav-button {
            flex: 1;
            padding: 10px 5px;
            background-color: transparent;
            border: none;
            color: var(--nav-text);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            transition: color 0.3s, background-color 0.3s;
            border-radius: 0;
        }
        .bottom-nav .nav-button .icon {
            font-size: var(--nav-icon-size);
        }
        .bottom-nav .nav-button:hover {
            color: var(--nav-active-text);
        }
        .bottom-nav .nav-button.active {
            color: var(--nav-active-text);
        }


        /* Hide/Show Utility */
        .hidden { display: none !important; }

        /* --- Floating Action Button (FAB) --- */
        .floating-action-button {
            position: fixed;
            bottom: 75px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--primary-accent);
            color: var(--button-primary-text);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 28px;
            font-weight: bold;
            line-height: 56px;
            text-align: center;
            cursor: pointer;
            z-index: 950;
            transition: background-color 0.3s, transform 0.2s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-action-button:hover {
            background-color: var(--primary-accent-darker);
            transform: scale(1.05);
        }
        body.dark-theme .floating-action-button {
            color: var(--button-primary-text);
        }

    </style>
</head>
<body>

    <!-- Adsterra Banner Ad -->
    <div style="text-align:center;">
        <script type="text/javascript">
            atOptions = {
                'key' : '71f3c4ee6e484b249ef7dfcb921cc1bb',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/71f3c4ee6e484b249ef7dfcb921cc1bb/invoke.js"></script>
    </div>



    <div class="app-container">
        <button id="settingsButton" class="settings-button" title="Settings">‚öôÔ∏è</button>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="settings-modal card hidden" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
            <div class="settings-modal-header">
                <h2 id="settingsModalTitle">Settings</h2>
                <button id="closeSettingsModalButton" class="close-modal-btn" title="Close settings" aria-label="Close settings">&times;</button>
            </div>
            <div class="settings-modal-content">
                <div class="settings-option-row">
                    <label for="currencySelector">Currency</label>
                    <select id="currencySelector">
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="$">$ (USD)</option>
                        <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                        <option value="¬£">¬£ (GBP)</option>
                    </select>
                </div>
                <div class="settings-option-row">
                    <label id="appearanceLabel">Appearance</label>
                    <button id="themeToggleButtonModal" class="settings-action-button">
                        <!-- Text and title set by JS -->
                    </button>
                </div>
                <div class="settings-option-row">
                    <label for="languageSelector">Language</label>
                    <select id="languageSelector">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- End Settings Modal -->

        <!-- Smart List Section -->
        <section id="listSection" class="list-section card">
            <h3 class="list-section-title">Smart List</h3>
            <ul id="groceryList">
                 <li class="empty-message">Loading list...</li>
            </ul>
        </section>

        <!-- Add Item Section - Initially Hidden -->
        <section id="addSection" class="add-item-section card hidden">
            <h2><span class="icon">‚ûï</span>Add Item to Your List</h2>
            <p class="instructions">Enter item name, quantity and unit.</p>
            <div class="input-group">
                <label for="itemNameInput">Item Name</label>
                <input type="text" id="itemNameInput" placeholder="e.g., Organic Oil, Whole Milk">
            </div>
            <div class="inline-inputs">
                <div class="input-group">
                    <label for="itemQuantityInput">Quantity</label>
                    <input type="number" id="itemQuantityInput" value="1" min="0.1" step="any">
                </div>
                <div class="input-group">
                    <label for="itemUnitInput">Unit</label>
                    <select id="itemUnitInput">
                        <option value="pcs">pcs</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="liter">liter</option>
                        <option value="ml">ml</option>
                        <option value="box">box</option>
                        <option value="bottle">bottle</option>
                        <option value="can">can</option>
                        <option value="pack">pack</option>
                        <option value="bunch">bunch</option>
                        <option value="">other</option>
                    </select>
                </div>
            </div>
            <button id="addButton"><span class="icon">‚äï</span> Add to List</button>
        </section>


         <section id="summarySection" class="card">
            <div class="total-spent-section">
                <h2><span class="icon">üí∞</span>Total Spent (Current List)</h2>
                <div id="totalAmount" class="total-amount">‚Çπ0.00</div>
            </div>
            <button id="archiveButton" disabled><span class="icon">üì¶</span> Complete Shopping & Archive</button>
        </section>
    </div>
    
    <div class="bottom-nav">
        <div class="bottom-nav-inner">
            <button id="navHomeButton" class="nav-button active">
                <span class="icon">üè†</span>
                <span>Home</span>
            </button>
            <button id="navHistoryButton" class="nav-button">
                <span class="icon">üìú</span>
                <span>History</span>
            </button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay hidden"></div>

    <button id="addItemFAB" class="floating-action-button hidden" title="Add New Item">
        +
    </button>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const settingsModalTitleEl = document.getElementById('settingsModalTitle');
            const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
            const modalOverlay = document.getElementById('modalOverlay');
            const currencySelector = document.getElementById('currencySelector');
            const currencyLabelEl = document.querySelector('label[for="currencySelector"]');
            const appearanceLabelEl = document.getElementById('appearanceLabel');
            const themeToggleButton = document.getElementById('themeToggleButtonModal');
            const languageSelector = document.getElementById('languageSelector');
            const languageLabelEl = document.querySelector('label[for="languageSelector"]');
            
            const listSectionTitleEl = document.querySelector('#listSection .list-section-title');
            const addSection = document.getElementById('addSection');
            const addSectionTitleEl = addSection.querySelector('h2');
            const addSectionInstructionsEl = addSection.querySelector('.instructions');
            const itemNameInputLabel = addSection.querySelector('label[for="itemNameInput"]');
            const itemNameInput = document.getElementById('itemNameInput');
            const itemQuantityInputLabel = addSection.querySelector('label[for="itemQuantityInput"]');
            const itemQuantityInput = document.getElementById('itemQuantityInput');
            const itemUnitInputLabel = addSection.querySelector('label[for="itemUnitInput"]');
            const itemUnitInput = document.getElementById('itemUnitInput');
            const addButton = document.getElementById('addButton');
            
            const summarySection = document.getElementById('summarySection');
            const totalSpentTitleEl = summarySection.querySelector('.total-spent-section h2');
            const archiveButton = document.getElementById('archiveButton');
            
            const navHomeButton = document.getElementById('navHomeButton');     
            const navHistoryButton = document.getElementById('navHistoryButton');
            const navHomeButtonText = navHomeButton.querySelector('span:not(.icon)');
            const navHistoryButtonText = navHistoryButton.querySelector('span:not(.icon)');
            const addItemFAB = document.getElementById('addItemFAB');

            const groceryList = document.getElementById('groceryList');
            const totalAmountEl = document.getElementById('totalAmount');
            const listSection = document.getElementById('listSection');
            
            // Storage Keys
            const currentListKey = 'listifyAppItems_v3';
            const historyKey = 'listifyPurchaseHistory_v1';
            const currencyStorageKey = 'listifyAppCurrency_v1';
            const themeStorageKey = 'listifyTheme_v1';
            const languageStorageKey = 'listifyAppLanguage_v1';

            // State
            let items = [];
            let history = [];
            let isViewingHistory = false;
            let currentCurrencySymbol = '‚Çπ';
            let isDarkMode = false;
            let currentLanguage = 'en'; // Default language
            let unitOptionsHtml = '';
            let lastFocusedElement;

            // Translations
            const translations = {
                en: {
                    // General
                    pageTitle: "My Smart List",
                    settingsTitle: "Settings",
                    // Settings Modal
                    currencyLabel: "Currency",
                    appearanceLabel: "Appearance",
                    setLightTheme: "Set Light Theme ‚òÄÔ∏è",
                    setDarkTheme: "Set Dark Theme üåô",
                    languageLabel: "Language",
                    closeSettingsTitle: "Close settings",
                    // Main Page
                    smartListTitle: "Smart List",
                    addItemTitle: "Add Item to Your List",
                    addItemInstructions: "Enter item name, quantity and unit.",
                    itemNameLabel: "Item Name",
                    itemNamePlaceholder: "e.g., Organic Oil, Whole Milk", // Changed from Organic Apples
                    itemQuantityLabel: "Quantity",
                    itemUnitLabel: "Unit",
                    addToListButton: "Add to List",
                    totalSpentTitle: "Total Spent (Current List)",
                    archiveButtonText: "Complete Shopping & Archive",
                    navHome: "Home",
                    navHistory: "History",
                    addItemFABTitle: "Add New Item",
                    // List Item Placeholders & Actions
                    emptyListMessage: "Your current list is empty!",
                    emptyHistoryMessage: "Your purchase history is empty.",
                    editItemDetailsTitle: "Edit item details",
                    editPriceTitle: "Edit price",
                    enterPricePlaceholder: "Enter Price",
                    deleteItemAriaLabel: "Delete {itemName}",
                    // Item Edit Mode
                    itemNameLabelEdit: "Item Name",
                    itemQuantityLabelEdit: "Quantity",
                    itemUnitLabelEdit: "Unit",
                    saveButton: "Save",
                    cancelButton: "Cancel",
                    // History View
                    archivedLabel: "Archived",
                    atLabel: "at",
                    totalSpendLabel: "Total Spend",
                    removeGroupSessionTitle: "Remove this shopping session",
                    qtyLabel: "Qty",
                    paidLabel: "Paid",
                    noItemsInSessionLabel: "(No items were in this shopping session)",
                    totalSpentAllHistoryLabel: "Total Spent (All History)",
                    clearAllHistoryButton: "Clear All History",
                    // Alerts & Confirms
                    alertItemNameEmpty: "Please enter an item name.",
                    alertInvalidQuantity: "Please enter a valid positive quantity.",
                    alertItemNameCannotBeEmpty: "Item name cannot be empty.",
                    alertPriceNotEntered: "Price not entered. Item marked as incomplete.",
                    alertInvalidPrice: "Invalid price (e.g., 50.75). Item marked as incomplete.",
                    alertItemsArchived: "{count} item(s) moved to purchase history.",
                    alertNoItemsToArchive: "No completed items with prices to archive.",
                    confirmClearHistory: "Are you sure you want to clear all purchase history? This action cannot be undone.",
                    confirmRemoveHistoryGroup: "Are you sure you want to remove this shopping session from history?"
                },
                hi: {
                    // General
                    pageTitle: "‡§Æ‡•á‡§∞‡•Ä ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä",
                    settingsTitle: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",
                    // Settings Modal
                    currencyLabel: "‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ",
                    appearanceLabel: "‡§¶‡§ø‡§ñ‡§æ‡§µ‡§ü",
                    setLightTheme: "‡§≤‡§æ‡§á‡§ü ‡§•‡•Ä‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‚òÄÔ∏è",
                    setDarkTheme: "‡§°‡§æ‡§∞‡•ç‡§ï ‡§•‡•Ä‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç üåô",
                    languageLabel: "‡§≠‡§æ‡§∑‡§æ",
                    closeSettingsTitle: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                    // Main Page
                    smartListTitle: "‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä",
                    addItemTitle: "‡§Ö‡§™‡§®‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
                    addItemInstructions: "‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ, ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§î‡§∞ ‡§á‡§ï‡§æ‡§à ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
                    itemNameLabel: "‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ",
                    itemNamePlaceholder: "‡§ú‡•à‡§∏‡•á, ‡§ú‡•à‡§µ‡§ø‡§ï ‡§§‡•á‡§≤, ‡§™‡•Ç‡§∞‡§æ ‡§¶‡•Ç‡§ß", // Changed from ‡§ú‡•à‡§µ‡§ø‡§ï ‡§∏‡•á‡§¨
                    itemQuantityLabel: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
                    itemUnitLabel: "‡§á‡§ï‡§æ‡§à",
                    addToListButton: "‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
                    totalSpentTitle: "‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö (‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•Ç‡§ö‡•Ä)",
                    archiveButtonText: "‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π ‡§ï‡§∞‡•á‡§Ç",
                    navHome: "‡§π‡•ã‡§Æ",
                    navHistory: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
                    addItemFABTitle: "‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
                    // List Item Placeholders & Actions
                    emptyListMessage: "‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•Ç‡§ö‡•Ä ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à!",
                    emptyHistoryMessage: "‡§Ü‡§™‡§ï‡§æ ‡§ñ‡§∞‡•Ä‡§¶ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§",
                    editItemDetailsTitle: "‡§Ü‡§á‡§ü‡§Æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
                    editPriceTitle: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
                    enterPricePlaceholder: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
                    deleteItemAriaLabel: "{itemName} ‡§π‡§ü‡§æ‡§è‡§Ç",
                     // Item Edit Mode
                    itemNameLabelEdit: "‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ",
                    itemQuantityLabelEdit: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
                    itemUnitLabelEdit: "‡§á‡§ï‡§æ‡§à",
                    saveButton: "‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
                    cancelButton: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                    // History View
                    archivedLabel: "‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§",
                    atLabel: "‡§¨‡§ú‡•á",
                    totalSpendLabel: "‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö",
                    removeGroupSessionTitle: "‡§á‡§∏ ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§∏‡§§‡•ç‡§∞ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç",
                    qtyLabel: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
                    paidLabel: "‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ",
                    noItemsInSessionLabel: "(‡§á‡§∏ ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§∏‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§Ü‡§á‡§ü‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§•‡§æ)",
                    totalSpentAllHistoryLabel: "‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö (‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏)",
                    clearAllHistoryButton: "‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç",
                     // Alerts & Confirms
                    alertItemNameEmpty: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
                    alertInvalidQuantity: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§ï‡§æ‡§∞‡§æ‡§§‡•ç‡§Æ‡§ï ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
                    alertItemNameCannotBeEmpty: "‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ‡•§",
                    alertPriceNotEntered: "‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§¶‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§Ü‡§á‡§ü‡§Æ ‡§Ö‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§‡•§",
                    alertInvalidPrice: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‡§ú‡•à‡§∏‡•á, 50.75)‡•§ ‡§Ü‡§á‡§ü‡§Æ ‡§Ö‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§‡•§",
                    alertItemsArchived: "{count} ‡§Ü‡§á‡§ü‡§Æ ‡§ñ‡§∞‡•Ä‡§¶ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Æ‡•á‡§Ç ‡§≤‡•á ‡§ú‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§",
                    alertNoItemsToArchive: "‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ü‡§á‡§ü‡§Æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§",
                    confirmClearHistory: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡§æ‡§∞‡§æ ‡§ñ‡§∞‡•Ä‡§¶ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§",
                    confirmRemoveHistoryGroup: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§∏‡§§‡•ç‡§∞ ‡§ï‡•ã ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡•á ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?"
                }
            };

            function getTranslation(key, replacements = {}) {
                const langPack = translations[currentLanguage] || translations.en;
                let text = langPack[key] || (translations.en[key] || key);
                for (const placeholder in replacements) {
                    text = text.replace(`{${placeholder}}`, replacements[placeholder]);
                }
                return text;
            }

            function applyTranslations() {
                document.documentElement.lang = currentLanguage;
                document.title = getTranslation('pageTitle');
                
                // Settings Modal
                if (settingsModalTitleEl) settingsModalTitleEl.textContent = getTranslation('settingsTitle');
                if (currencyLabelEl) currencyLabelEl.textContent = getTranslation('currencyLabel');
                if (appearanceLabelEl) appearanceLabelEl.textContent = getTranslation('appearanceLabel');
                
                if (themeToggleButton) {
                    if (isDarkMode) {
                        themeToggleButton.textContent = getTranslation('setLightTheme');
                        themeToggleButton.title = getTranslation('setLightTheme').replace(/‚òÄÔ∏è|üåô/g, '').trim();
                    } else {
                        themeToggleButton.textContent = getTranslation('setDarkTheme');
                        themeToggleButton.title = getTranslation('setDarkTheme').replace(/‚òÄÔ∏è|üåô/g, '').trim();
                    }
                }
                if (languageLabelEl) languageLabelEl.textContent = getTranslation('languageLabel');
                if (settingsButton) settingsButton.title = getTranslation('settingsTitle');
                if (closeSettingsModalButton) {
                    closeSettingsModalButton.title = getTranslation('closeSettingsTitle');
                    closeSettingsModalButton.setAttribute('aria-label', getTranslation('closeSettingsTitle'));
                }

                // Main Page
                if (listSectionTitleEl) listSectionTitleEl.innerHTML = `${getTranslation('smartListTitle')} üõí`;
                
                if (addSectionTitleEl) {
                    const iconSpan = addSectionTitleEl.querySelector('.icon');
                    addSectionTitleEl.innerHTML = (iconSpan ? iconSpan.outerHTML : '') + getTranslation('addItemTitle');
                }
                if (addSectionInstructionsEl) addSectionInstructionsEl.textContent = getTranslation('addItemInstructions');
                if (itemNameInputLabel) itemNameInputLabel.textContent = getTranslation('itemNameLabel');
                if (itemNameInput) itemNameInput.placeholder = getTranslation('itemNamePlaceholder');
                if (itemQuantityInputLabel) itemQuantityInputLabel.textContent = getTranslation('itemQuantityLabel');
                if (itemUnitInputLabel) itemUnitInputLabel.textContent = getTranslation('itemUnitLabel');
                
                if (addButton) {
                    const iconSpan = addButton.querySelector('.icon');
                    addButton.innerHTML = (iconSpan ? iconSpan.outerHTML : '') + getTranslation('addToListButton');
                }
                
                if (totalSpentTitleEl) {
                     const iconSpan = totalSpentTitleEl.querySelector('.icon');
                    totalSpentTitleEl.innerHTML = (iconSpan ? iconSpan.outerHTML : '') + getTranslation('totalSpentTitle');
                }
                if (archiveButton) {
                    const iconSpan = archiveButton.querySelector('.icon');
                    archiveButton.innerHTML = (iconSpan ? iconSpan.outerHTML : '') + getTranslation('archiveButtonText');
                }

                if (navHomeButtonText) navHomeButtonText.textContent = getTranslation('navHome');
                if (navHistoryButtonText) navHistoryButtonText.textContent = getTranslation('navHistory');
                if (addItemFAB) addItemFAB.title = getTranslation('addItemFABTitle');

                if (isViewingHistory) {
                    renderHistoryList();
                } else {
                    renderCurrentList();
                }
                calculateAndDisplayTotal();
            }


            // --- Theme Functions ---
            function loadThemePreference() {
                const savedTheme = localStorage.getItem(themeStorageKey);
                if (savedTheme) {
                    isDarkMode = (savedTheme === 'dark');
                } else {
                    isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                if (isDarkMode) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }

            function saveThemePreference() {
                localStorage.setItem(themeStorageKey, isDarkMode ? 'dark' : 'light');
            }

            function toggleTheme() {
                isDarkMode = !isDarkMode;
                document.body.classList.toggle('dark-theme');
                applyTranslations();
                saveThemePreference();
            }
            
            // --- Currency Functions ---
            function loadCurrencyPreference() {
                const storedSymbol = localStorage.getItem(currencyStorageKey);
                if (storedSymbol !== null) {
                    currentCurrencySymbol = storedSymbol;
                }
                if (currencySelector) currencySelector.value = currentCurrencySymbol;
            }

            function saveCurrencyPreference() {
                localStorage.setItem(currencyStorageKey, currentCurrencySymbol);
            }
            
            function formatCurrency(amount) {
                const formattedNumber = Number(amount).toFixed(2);
                return currentCurrencySymbol ? `${currentCurrencySymbol}${formattedNumber}` : formattedNumber;
            }

            // --- Language Functions ---
            function loadLanguagePreference() {
                const storedLanguage = localStorage.getItem(languageStorageKey);
                currentLanguage = storedLanguage || 'en'; // Default to 'en' if nothing is stored
                if (languageSelector) languageSelector.value = currentLanguage;
            }

            function saveLanguagePreference() {
                localStorage.setItem(languageStorageKey, currentLanguage);
            }

            function handleLanguageChange() {
                if (languageSelector) {
                    currentLanguage = languageSelector.value;
                    saveLanguagePreference();
                    applyTranslations();
                }
            }

            // --- Data Load/Save ---
            function loadData() {
                const storedItems = localStorage.getItem(currentListKey);
                if (storedItems) { try { items = JSON.parse(storedItems); if (!Array.isArray(items)) items = []; items = items.map(item => ({ ...item, price: item.price || null })); } catch (e) { console.error("Error parsing current list:", e); items = []; } }
                const storedHistory = localStorage.getItem(historyKey);
                if (storedHistory) { try { history = JSON.parse(storedHistory); if (!Array.isArray(history)) history = []; } catch (e) { console.error("Error parsing history:", e); history = []; } }
            }
            function saveCurrentList() { localStorage.setItem(currentListKey, JSON.stringify(items)); }
            function saveHistory() { localStorage.setItem(historyKey, JSON.stringify(history)); }
            
            // --- Unit Options ---
            function populateUnitOptions() {
                unitOptionsHtml = '';
                const mainUnitSelect = document.getElementById('itemUnitInput');
                if (mainUnitSelect) {
                    Array.from(mainUnitSelect.options).forEach(opt => {
                        unitOptionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
                    });
                }
            }

            // --- Settings Modal Functions ---
            function openSettingsModal() {
                lastFocusedElement = document.activeElement;
                settingsModal.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
                if (currencySelector) currencySelector.focus();
            }

            function closeSettingsModal() {
                settingsModal.classList.add('hidden');
                modalOverlay.classList.add('hidden');
                if (lastFocusedElement) {
                    lastFocusedElement.focus();
                }
            }

            // --- Rendering Functions ---
            function renderCurrentList() {
                groceryList.innerHTML = '';
                const existingClearButton = listSection.querySelector('#clearHistoryBtn');
                if (existingClearButton) existingClearButton.remove();

                if (items.length === 0) {
                    groceryList.innerHTML = `<li class="empty-message">${getTranslation('emptyListMessage')}</li>`;
                    return;
                }
                
                items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.dataset.index = index;
                    if (item.completed) li.classList.add('completed');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = item.completed;
                    checkbox.addEventListener('change', () => toggleComplete(index));
                    
                    const detailsDiv = document.createElement('div');
                    detailsDiv.classList.add('item-details');
                    
                    const itemViewModeDiv = document.createElement('div');
                    itemViewModeDiv.classList.add('item-view-mode');

                    const itemNameLineDiv = document.createElement('div');
                    itemNameLineDiv.classList.add('item-name-line');
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('item-name');
                    nameSpan.textContent = item.name;
                    itemNameLineDiv.appendChild(nameSpan);

                    const editItemButton = document.createElement('button');
                    editItemButton.classList.add('edit-item-btn');
                    editItemButton.innerHTML = '‚úé';
                    editItemButton.title = getTranslation('editItemDetailsTitle');
                    editItemButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        switchToItemEditMode(li, index);
                    });
                    itemNameLineDiv.appendChild(editItemButton);
                    itemViewModeDiv.appendChild(itemNameLineDiv);
                    
                    const qtyUnitSpan = document.createElement('span');
                    qtyUnitSpan.classList.add('item-qty-unit');
                    const formattedQuantity = parseFloat(item.quantity) % 1 === 0 ? parseInt(item.quantity) : parseFloat(item.quantity);
                    qtyUnitSpan.textContent = `(${getTranslation('qtyLabel')}: ${formattedQuantity} ${item.unit || ''})`.trim();
                    itemViewModeDiv.appendChild(qtyUnitSpan);
                    
                    const priceContainer = document.createElement('div');
                    priceContainer.classList.add('item-price-container');

                    const priceSpan = document.createElement('span');
                    priceSpan.classList.add('item-price');
                    
                    const editPriceButton = document.createElement('button');
                    editPriceButton.classList.add('edit-price-btn');
                    editPriceButton.innerHTML = '‚úé';
                    editPriceButton.title = getTranslation('editPriceTitle');
                    editPriceButton.style.display = 'none';
                    editPriceButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showPriceEditInput(index);
                    });

                    if (item.completed && item.price !== null) {
                        priceSpan.textContent = `${getTranslation('paidLabel')}: ${formatCurrency(item.price)}`;
                        editPriceButton.style.display = 'inline-block';
                    } else {
                        priceSpan.style.display = 'none';
                    }
                    priceContainer.appendChild(priceSpan);
                    priceContainer.appendChild(editPriceButton);
                    itemViewModeDiv.appendChild(priceContainer);
                    
                    const priceInput = document.createElement('input');
                    priceInput.type = 'number';
                    priceInput.inputMode = 'decimal';
                    priceInput.step = '0.01';
                    priceInput.classList.add('item-price-input');
                    priceInput.placeholder = getTranslation('enterPricePlaceholder');
                    priceInput.style.display = 'none';
                    priceInput.dataset.index = index;
                    priceInput.addEventListener('blur', (e) => handlePriceInput(e.target));
                    priceInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') { e.preventDefault(); handlePriceInput(e.target); }
                        else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelPriceEdit(e.target, index);
                        }
                    });
                    priceContainer.appendChild(priceInput);
                    detailsDiv.appendChild(itemViewModeDiv);

                    const itemEditModeDiv = document.createElement('div');
                    itemEditModeDiv.classList.add('item-edit-mode');
                    itemEditModeDiv.style.display = 'none';

                    const nameEditGroup = document.createElement('div');
                    nameEditGroup.classList.add('input-group-condensed');
                    const nameEditLabel = document.createElement('label');
                    nameEditLabel.textContent = getTranslation('itemNameLabelEdit');
                    const nameEditInputEl = document.createElement('input');
                    nameEditInputEl.type = 'text';
                    nameEditInputEl.classList.add('item-name-edit-input');
                    nameEditInputEl.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') { e.preventDefault(); saveItemChanges(li, index); }
                        if (e.key === 'Escape') { e.preventDefault(); cancelItemChanges(li, index); }
                    });
                    nameEditGroup.appendChild(nameEditLabel);
                    nameEditGroup.appendChild(nameEditInputEl);
                    itemEditModeDiv.appendChild(nameEditGroup);

                    const qtyUnitEditInlineDiv = document.createElement('div');
                    qtyUnitEditInlineDiv.classList.add('inline-inputs-condensed');

                    const qtyEditGroup = document.createElement('div');
                    qtyEditGroup.classList.add('input-group-condensed');
                    const qtyEditLabel = document.createElement('label');
                    qtyEditLabel.textContent = getTranslation('itemQuantityLabelEdit');
                    const qtyEditInput = document.createElement('input');
                    qtyEditInput.type = 'number';
                    qtyEditInput.min = '0.1';
                    qtyEditInput.step = 'any';
                    qtyEditInput.classList.add('item-quantity-edit-input');
                     qtyEditInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') { e.preventDefault(); saveItemChanges(li, index); }
                        if (e.key === 'Escape') { e.preventDefault(); cancelItemChanges(li, index); }
                    });
                    qtyEditGroup.appendChild(qtyEditLabel);
                    qtyEditGroup.appendChild(qtyEditInput);
                    qtyUnitEditInlineDiv.appendChild(qtyEditGroup);

                    const unitEditGroup = document.createElement('div');
                    unitEditGroup.classList.add('input-group-condensed');
                    const unitEditLabel = document.createElement('label');
                    unitEditLabel.textContent = getTranslation('itemUnitLabelEdit');
                    const unitEditSelect = document.createElement('select');
                    unitEditSelect.classList.add('item-unit-edit-select');
                    unitEditSelect.innerHTML = unitOptionsHtml;
                    unitEditSelect.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') { e.preventDefault(); cancelItemChanges(li, index); }
                    });
                    unitEditGroup.appendChild(unitEditLabel);
                    unitEditGroup.appendChild(unitEditSelect);
                    qtyUnitEditInlineDiv.appendChild(unitEditGroup);
                    itemEditModeDiv.appendChild(qtyUnitEditInlineDiv);

                    const editActionsDiv = document.createElement('div');
                    editActionsDiv.classList.add('item-edit-actions');
                    const saveChangesButton = document.createElement('button');
                    saveChangesButton.classList.add('save-item-edit-btn');
                    saveChangesButton.textContent = getTranslation('saveButton');
                    saveChangesButton.addEventListener('click', () => saveItemChanges(li, index));
                    const cancelChangesButton = document.createElement('button');
                    cancelChangesButton.classList.add('cancel-item-edit-btn');
                    cancelChangesButton.textContent = getTranslation('cancelButton');
                    cancelChangesButton.addEventListener('click', () => cancelItemChanges(li, index));
                    editActionsDiv.appendChild(saveChangesButton);
                    editActionsDiv.appendChild(cancelChangesButton);
                    itemEditModeDiv.appendChild(editActionsDiv);
                    
                    detailsDiv.appendChild(itemEditModeDiv);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = 'üóëÔ∏è'; // Changed icon here
                    deleteButton.classList.add('delete-btn');
                    deleteButton.setAttribute('aria-label', getTranslation('deleteItemAriaLabel', {itemName: item.name}));
                    deleteButton.addEventListener('click', (e) => { e.stopPropagation(); deleteItem(index); });
                    
                    li.appendChild(checkbox);
                    li.appendChild(detailsDiv);
                    li.appendChild(deleteButton);
                    groceryList.appendChild(li);
                });
            }

            function renderHistoryList() {
                groceryList.innerHTML = '';
                const existingClearButton = listSection.querySelector('#clearHistoryBtn');
                if (existingClearButton) existingClearButton.remove();

                if (history.length === 0) {
                    groceryList.innerHTML = `<li class="empty-message">${getTranslation('emptyHistoryMessage')}</li>`;
                    return;
                }
                const sortedHistoryEntries = [...history].sort((a, b) => b.timestamp - a.timestamp);
                let overallGrandTotal = 0;
                sortedHistoryEntries.forEach(entry => {
                    const groupHeaderLi = document.createElement('li'); groupHeaderLi.classList.add('history-group-header');
                    const dateObject = new Date(entry.timestamp);
                    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' }; const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
                    const formattedDate = dateObject.toLocaleDateString(undefined, dateOptions); const formattedTime = dateObject.toLocaleTimeString(undefined, timeOptions);
                    groupHeaderLi.textContent = `${getTranslation('archivedLabel')}: ${formattedDate} ${getTranslation('atLabel')} ${formattedTime}`;
                    groceryList.appendChild(groupHeaderLi);
                    let groupTotal = 0;
                    if (entry.purchasedItems && entry.purchasedItems.length > 0) {
                        groupTotal = entry.purchasedItems.reduce((sum, item) => { if (typeof item.price === 'number' && !isNaN(item.price)) { return sum + item.price; } return sum; }, 0);
                        entry.purchasedItems.forEach(item => {
                            const li = document.createElement('li'); li.classList.add('history-item');
                            const detailsDiv = document.createElement('div'); detailsDiv.classList.add('item-details');
                            const nameSpan = document.createElement('span'); nameSpan.classList.add('item-name'); nameSpan.textContent = item.name; detailsDiv.appendChild(nameSpan);
                            const qtyUnitSpan = document.createElement('span'); qtyUnitSpan.classList.add('item-qty-unit'); const formattedQuantity = parseFloat(item.quantity) % 1 === 0 ? parseInt(item.quantity) : parseFloat(item.quantity);
                            qtyUnitSpan.textContent = `(${getTranslation('qtyLabel')}: ${formattedQuantity} ${item.unit || ''})`;
                            detailsDiv.appendChild(qtyUnitSpan);
                            if (item.price !== null) {
                                const priceSpan = document.createElement('span'); priceSpan.classList.add('item-price');
                                priceSpan.textContent = `${getTranslation('paidLabel')}: ${formatCurrency(item.price)}`;
                                detailsDiv.appendChild(priceSpan);
                            }
                            li.appendChild(detailsDiv); groceryList.appendChild(li);
                        });
                    } else {
                        const noItemsInSessionLi = document.createElement('li');
                        noItemsInSessionLi.classList.add('empty-message', 'history-group-empty-item');
                        noItemsInSessionLi.textContent = getTranslation('noItemsInSessionLabel');
                        noItemsInSessionLi.style.fontSize = "0.8em";
                        groceryList.appendChild(noItemsInSessionLi);
                    }
                    overallGrandTotal += groupTotal;
                    const groupTotalLi = document.createElement('li'); groupTotalLi.classList.add('history-group-total');
                    const totalTextSpan = document.createElement('span'); totalTextSpan.classList.add('history-group-total-text');
                    totalTextSpan.textContent = `${getTranslation('totalSpendLabel')}: ${formatCurrency(groupTotal)}`;
                    groupTotalLi.appendChild(totalTextSpan);
                    const removeGroupButton = document.createElement('button');
                    removeGroupButton.classList.add('remove-group-btn');
                    removeGroupButton.innerHTML = '&#x2716;';
                    removeGroupButton.title = getTranslation('removeGroupSessionTitle');
                    removeGroupButton.dataset.timestamp = entry.timestamp;
                    removeGroupButton.addEventListener('click', (e) => { e.stopPropagation(); confirmAndRemoveHistoryGroup(entry.timestamp); });
                    groupTotalLi.appendChild(removeGroupButton); groceryList.appendChild(groupTotalLi);
                });
                if (history.length > 0) {
                    const grandTotalDisplayLi = document.createElement('li');
                    grandTotalDisplayLi.classList.add('history-overall-total');
                    grandTotalDisplayLi.textContent = `${getTranslation('totalSpentAllHistoryLabel')}: ${formatCurrency(overallGrandTotal)}`;
                    groceryList.appendChild(grandTotalDisplayLi);
                    
                    if (!listSection.querySelector('#clearHistoryBtn')) {
                        const clearButton = document.createElement('button');
                        clearButton.id = 'clearHistoryBtn';
                        clearButton.textContent = getTranslation('clearAllHistoryButton');
                        clearButton.classList.add('clear-history-button');
                        clearButton.addEventListener('click', confirmAndClearAllHistory);
                        listSection.appendChild(clearButton);
                    }
                } else {
                    groceryList.innerHTML = `<li class="empty-message">${getTranslation('emptyHistoryMessage')}</li>`;
                }
            }
            
            // --- Action Functions ---
            function confirmAndClearAllHistory() { if (confirm(getTranslation('confirmClearHistory'))) { history = []; saveHistory(); renderHistoryList(); } }
            function confirmAndRemoveHistoryGroup(timestampToRemove) { if (confirm(getTranslation('confirmRemoveHistoryGroup'))) { history = history.filter(entry => entry.timestamp !== timestampToRemove); saveHistory(); renderHistoryList(); } }
            
            function switchToItemEditMode(liElement, index) {
                if (isViewingHistory) return;
                const item = items[index];
                if (!item) return;

                if (!addSection.classList.contains('hidden')) {
                    addSection.classList.add('hidden');
                }

                const viewModeDiv = liElement.querySelector('.item-view-mode');
                const editModeDiv = liElement.querySelector('.item-edit-mode');
                
                const nameEditInput = editModeDiv.querySelector('.item-name-edit-input');
                const qtyEditInput = editModeDiv.querySelector('.item-quantity-edit-input');
                const unitEditSelect = editModeDiv.querySelector('.item-unit-edit-select');

                nameEditInput.value = item.name;
                qtyEditInput.value = item.quantity;
                unitEditSelect.value = item.unit;

                viewModeDiv.style.display = 'none';
                editModeDiv.style.display = 'flex';
                nameEditInput.focus();
                nameEditInput.select();
            }

            function saveItemChanges(liElement, index) {
                if (isViewingHistory) return;
                const item = items[index];
                if (!item) return;

                const editModeDiv = liElement.querySelector('.item-edit-mode');
                const nameEditInput = editModeDiv.querySelector('.item-name-edit-input');
                const qtyEditInput = editModeDiv.querySelector('.item-quantity-edit-input');
                const unitEditSelect = editModeDiv.querySelector('.item-unit-edit-select');

                const newName = nameEditInput.value.trim();
                const newQuantityStr = qtyEditInput.value.trim();
                const newUnit = unitEditSelect.value;

                if (newName === '') {
                    alert(getTranslation('alertItemNameCannotBeEmpty'));
                    nameEditInput.focus();
                    return;
                }
                const newQuantity = parseFloat(newQuantityStr);
                if (isNaN(newQuantity) || newQuantity <= 0) {
                    alert(getTranslation('alertInvalidQuantity'));
                    qtyEditInput.focus();
                    return;
                }

                item.name = newName;
                item.quantity = newQuantity;
                item.unit = newUnit;

                saveCurrentList();
                updateItemViewMode(liElement, item);
                switchToItemViewMode(liElement);
                
                const deleteButton = liElement.querySelector('.delete-btn');
                if (deleteButton) deleteButton.setAttribute('aria-label', getTranslation('deleteItemAriaLabel', {itemName: newName}));
            }

            function cancelItemChanges(liElement, index) {
                 if (isViewingHistory) return;
                 switchToItemViewMode(liElement);
            }

            function switchToItemViewMode(liElement) {
                const viewModeDiv = liElement.querySelector('.item-view-mode');
                const editModeDiv = liElement.querySelector('.item-edit-mode');
                viewModeDiv.style.display = 'block';
                editModeDiv.style.display = 'none';
            }
            
            function updateItemViewMode(liElement, item) {
                const nameSpan = liElement.querySelector('.item-view-mode .item-name');
                const qtyUnitSpan = liElement.querySelector('.item-view-mode .item-qty-unit');
                if (nameSpan) nameSpan.textContent = item.name;
                if (qtyUnitSpan) {
                    const formattedQuantity = parseFloat(item.quantity) % 1 === 0 ? parseInt(item.quantity) : parseFloat(item.quantity);
                    qtyUnitSpan.textContent = `(${getTranslation('qtyLabel')}: ${formattedQuantity} ${item.unit || ''})`.trim();
                }
            }

            function showPriceEditInput(index) {
                const item = items[index];
                if (!item || !item.completed) return;

                if (!addSection.classList.contains('hidden')) {
                    addSection.classList.add('hidden');
                }

                const liElement = groceryList.querySelector(`li[data-index="${index}"]`);
                if (!liElement) return;

                const priceInputElement = liElement.querySelector('.item-price-input');
                const priceDisplaySpan = liElement.querySelector('.item-price');
                const editPriceButton = liElement.querySelector('.edit-price-btn');

                if (priceInputElement && priceDisplaySpan && editPriceButton) {
                    priceDisplaySpan.style.display = 'none';
                    editPriceButton.style.display = 'none';

                    priceInputElement.value = item.price !== null ? Number(item.price).toFixed(2) : '';
                    priceInputElement.style.display = 'block';
                    priceInputElement.focus();
                    priceInputElement.select();
                }
            }

            function cancelPriceEdit(inputElement, index) {
                const item = items[index];
                if (!item) return;
                const liElement = inputElement.closest('li');
                if (!liElement) return;

                const priceDisplaySpan = liElement.querySelector('.item-price');
                const editPriceButton = liElement.querySelector('.edit-price-btn');
                
                inputElement.style.display = 'none';

                if (item.price !== null && item.completed) {
                    if (priceDisplaySpan) {
                        priceDisplaySpan.textContent = `${getTranslation('paidLabel')}: ${formatCurrency(item.price)}`;
                        priceDisplaySpan.style.display = 'inline';
                    }
                    if (editPriceButton) editPriceButton.style.display = 'inline-block';
                } else {
                     if (priceDisplaySpan) priceDisplaySpan.style.display = 'none';
                     if (editPriceButton) editPriceButton.style.display = 'none';
                }
            }


            function addItem() {
                const name = itemNameInput.value.trim();
                const quantity = itemQuantityInput.value.trim() || '1';
                const unit = itemUnitInput.value;
                if (name === '') { alert(getTranslation('alertItemNameEmpty')); itemNameInput.focus(); return; }
                const numQuantity = parseFloat(quantity);
                if (isNaN(numQuantity) || numQuantity <= 0) { alert(getTranslation('alertInvalidQuantity')); itemQuantityInput.focus(); return; }
                
                items.push({ name: name, quantity: numQuantity, unit: unit, completed: false, price: null });
                
                itemNameInput.value = '';
                itemQuantityInput.value = '1';
                itemUnitInput.value = 'pcs';
                
                saveCurrentList();
                renderCurrentList();
                calculateAndDisplayTotal();
                updateArchiveButtonState();

                addSection.classList.add('hidden');
            }
            function deleteItem(index) { if (isViewingHistory) return; items.splice(index, 1); saveCurrentList(); renderCurrentList(); calculateAndDisplayTotal(); updateArchiveButtonState(); }
            
            function toggleComplete(index) {
                if (isViewingHistory || !items[index]) return;
                
                const item = items[index];
                const liElement = groceryList.querySelector(`li[data-index="${index}"]`);
                if (!liElement) return;

                if (!addSection.classList.contains('hidden')) {
                    addSection.classList.add('hidden');
                }

                const priceInputElement = liElement.querySelector('.item-price-input');
                const priceDisplayElement = liElement.querySelector('.item-price');
                const editPriceButton = liElement.querySelector('.edit-price-btn');
                const checkbox = liElement.querySelector('input[type="checkbox"]');

                const becomingComplete = !item.completed;

                if (becomingComplete) {
                    item.completed = true;
                    if (item.price === null) {
                        checkbox.checked = true;
                        liElement.classList.add('completed');

                        if (priceDisplayElement) priceDisplayElement.style.display = 'none';
                        if (editPriceButton) editPriceButton.style.display = 'none';
                        if (priceInputElement) {
                            priceInputElement.value = '';
                            priceInputElement.style.display = 'block';
                            priceInputElement.focus();
                        }
                        calculateAndDisplayTotal();
                        updateArchiveButtonState();
                        return;
                    } else {
                        if (priceDisplayElement) {
                            priceDisplayElement.textContent = `${getTranslation('paidLabel')}: ${formatCurrency(item.price)}`;
                            priceDisplayElement.style.display = 'inline';
                        }
                        if (editPriceButton) editPriceButton.style.display = 'inline-block';
                        if (priceInputElement) priceInputElement.style.display = 'none';
                    }
                } else {
                    item.completed = false;
                    item.price = null;
                    if (priceInputElement) priceInputElement.style.display = 'none';
                    if (priceDisplayElement) priceDisplayElement.style.display = 'none';
                    if (editPriceButton) editPriceButton.style.display = 'none';
                }

                saveCurrentList();
                renderCurrentList();
                calculateAndDisplayTotal();
                updateArchiveButtonState();
            }

            function handlePriceInput(inputElement) {
                const index = parseInt(inputElement.dataset.index); const item = items[index]; if (!item) return;
                const liElement = groceryList.querySelector(`li[data-index="${index}"]`);
                const priceDisplayElement = liElement.querySelector('.item-price');
                const editPriceButton = liElement.querySelector('.edit-price-btn');

                const priceValue = inputElement.value.trim();
                inputElement.style.display = 'none';
                
                if (priceValue === '') {
                    item.price = null;
                    if (item.completed) {
                         item.completed = false;
                         alert(getTranslation('alertPriceNotEntered'));
                    }
                    if (priceDisplayElement) priceDisplayElement.style.display = 'none';
                    if (editPriceButton) editPriceButton.style.display = 'none';
                } else {
                    const price = parseFloat(priceValue);
                    if (!isNaN(price) && price >= 0) {
                        item.price = price;
                        item.completed = true;
                        if (priceDisplayElement) {
                            priceDisplayElement.textContent = `${getTranslation('paidLabel')}: ${formatCurrency(item.price)}`;
                            priceDisplayElement.style.display = 'inline';
                        }
                        if (editPriceButton) editPriceButton.style.display = 'inline-block';
                    } else {
                        item.price = null;
                        if(item.completed){
                            item.completed = false;
                            alert(getTranslation('alertInvalidPrice'));
                        }
                        if (priceDisplayElement) priceDisplayElement.style.display = 'none';
                        if (editPriceButton) editPriceButton.style.display = 'none';
                    }
                }
                saveCurrentList(); renderCurrentList(); calculateAndDisplayTotal(); updateArchiveButtonState();
            }
            function calculateAndDisplayTotal() { const total = items.reduce((sum, item) => { if (item.completed && typeof item.price === 'number' && !isNaN(item.price)) { return sum + item.price; } return sum; }, 0); totalAmountEl.textContent = formatCurrency(total); }
            function updateArchiveButtonState() { const canArchive = items.some(item => item.completed && item.price !== null); archiveButton.disabled = !canArchive; }
            function archivePurchasedItems() {
                if (isViewingHistory) return;
                
                if (!addSection.classList.contains('hidden')) {
                    addSection.classList.add('hidden');
                }

                const itemsToArchive = items.filter(item => item.completed && item.price !== null);
                const remainingItems = items.filter(item => !item.completed || item.price === null);
                if (itemsToArchive.length > 0) {
                    history.push({ timestamp: Date.now(), purchasedItems: itemsToArchive });
                    saveHistory(); items = remainingItems;
                    saveCurrentList();
                    renderCurrentList();
                    calculateAndDisplayTotal();
                    updateArchiveButtonState();
                    alert(getTranslation('alertItemsArchived', {count: itemsToArchive.length}));
                }
                else { alert(getTranslation('alertNoItemsToArchive')); }
            }

            // --- UI Navigation ---
            function updateNavActiveState() {
                if (isViewingHistory) {
                    navHistoryButton.classList.add('active');
                    navHomeButton.classList.remove('active');
                } else {
                    navHomeButton.classList.add('active');
                    navHistoryButton.classList.remove('active');
                }
            }

            function displayHistoryViewUI() {
                addSection.classList.add('hidden');
                summarySection.classList.add('hidden');
                addItemFAB.classList.add('hidden');
                renderHistoryList();
                updateNavActiveState();
            }
            function displayCurrentListUI() {
                addSection.classList.add('hidden');
                summarySection.classList.remove('hidden');
                addItemFAB.classList.remove('hidden');
                renderCurrentList();
                calculateAndDisplayTotal();
                updateArchiveButtonState();
                updateNavActiveState();
            }
            
            function navigateToHomeView() {
                if (isViewingHistory) {
                    isViewingHistory = false;
                    displayCurrentListUI();
                    if (window.location.hash === '#history') {
                        window.history.pushState({ view: 'home' }, '', window.location.pathname + window.location.search);
                    }
                }
                if (!addSection.classList.contains('hidden')) {
                    addSection.classList.add('hidden');
                }
            }

            function navigateToHistoryView() {
                 if (!isViewingHistory) {
                    isViewingHistory = true;
                    addSection.classList.add('hidden');
                    displayHistoryViewUI();
                    window.history.pushState({ view: 'history' }, '', '#history');
                }
            }

            // --- FAB Click Handler ---
            function handleAddItemFABClick() {
                if (isViewingHistory) {
                    navigateToHomeView();
                }

                if (addSection.classList.contains('hidden')) {
                    addSection.classList.remove('hidden');
                    setTimeout(() => {
                         addSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                         if (itemNameInput) itemNameInput.focus();
                    }, 50);
                   
                } else {
                    addSection.classList.add('hidden');
                }
            }
            
            function handleCurrencyChange() {
                if (currencySelector) currentCurrencySymbol = currencySelector.value;
                saveCurrencyPreference();
                calculateAndDisplayTotal();
                if (isViewingHistory) {
                    renderHistoryList();
                } else {
                    renderCurrentList();
                }
            }

            // --- Event Listeners ---
            if (themeToggleButton) themeToggleButton.addEventListener('click', toggleTheme);
            if (settingsButton) settingsButton.addEventListener('click', openSettingsModal);
            if (closeSettingsModalButton) closeSettingsModalButton.addEventListener('click', closeSettingsModal);
            if (modalOverlay) modalOverlay.addEventListener('click', closeSettingsModal);

            if (addButton) addButton.addEventListener('click', addItem);
            if (archiveButton) archiveButton.addEventListener('click', archivePurchasedItems);
            
            if (navHomeButton) navHomeButton.addEventListener('click', navigateToHomeView);
            if (navHistoryButton) navHistoryButton.addEventListener('click', navigateToHistoryView);
            if (addItemFAB) addItemFAB.addEventListener('click', handleAddItemFABClick);

            if (itemNameInput) itemNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
            if (itemQuantityInput) itemQuantityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
            if (currencySelector) currencySelector.addEventListener('change', handleCurrencyChange);
            if (languageSelector) languageSelector.addEventListener('change', handleLanguageChange);
            
            window.addEventListener('popstate', (event) => {
                if (window.location.hash === '#history') {
                    if (!isViewingHistory) {
                        isViewingHistory = true;
                        addSection.classList.add('hidden');
                        displayHistoryViewUI();
                    }
                } else {
                    if (isViewingHistory) {
                        isViewingHistory = false;
                        displayCurrentListUI();
                    }
                }
                updateNavActiveState();
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!settingsModal.classList.contains('hidden')) {
                        closeSettingsModal();
                    } else if (!addSection.classList.contains('hidden') && !isViewingHistory) {
                        const activeEl = document.activeElement;
                        const isInputFocusedInAddSection = activeEl === itemNameInput || activeEl === itemQuantityInput || activeEl === itemUnitInput;
                        
                        let isInputFocusedInList = false;
                        if (activeEl && activeEl.closest('#groceryList li')) {
                           isInputFocusedInList = activeEl.tagName === 'INPUT' || activeEl.tagName === 'SELECT';
                        }

                        if (!isInputFocusedInAddSection && !isInputFocusedInList) {
                           addSection.classList.add('hidden');
                        }
                    }
                }
            });

            // --- Initial Load ---
            loadThemePreference();
            populateUnitOptions();
            loadData();                 
            loadCurrencyPreference();   
            loadLanguagePreference();
            applyTranslations();      
                                        
            if (window.location.hash === '#history') {
                isViewingHistory = true;
                displayHistoryViewUI();
            } else {
                isViewingHistory = false;
                displayCurrentListUI();
            }
        });
    </script>

</body>
</html>